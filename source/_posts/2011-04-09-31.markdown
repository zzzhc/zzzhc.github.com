---
layout: post
title: 'nodejs'
date: 2011-4-9
wordpress_id: 31
permalink: /blogs/31
comments: true
---
<a href="http://nodejs.org/" target="_blank">nodejs</a> Evented I/O for         <a href="http://code.google.com/p/v8/">V8 JavaScript</a>.

node的目标是提供一种简单的方式来构建可伸缩的网络程序。在node里几乎没有函数会直接执行IO操作，进程从不会阻塞在某个IO等待上。event, callback是node中两个主要的概念，因为IO操作不阻塞，通过event, callback来实现是很自然的。

这一两年node发展很快，有了包管理器(<a href="http://github.com/isaacs/npm" target="_blank">npm</a>)，也出现了各种各样的module, 如
<ul>
	<li>Web Framework: <a href="http://github.com/visionmedia/express" target="_blank">Express</a>, node的<a href="http://www.sinatrarb.com/" target="_blank">sinatra</a></li>
	<li>template engine: <a href="https://github.com/visionmedia/haml.js" target="_blank">hamljs</a></li>
	<li>mysql driver:<a href="http://github.com/felixge/node-mysql" target="_blank">node-mysql</a></li>
	<li>mongodb client: <a href="https://github.com/christkv/node-mongodb-native" target="_blank">node-mongodb-native</a></li>
	<li>redis client: <a href="https://github.com/mranney/node_redis" target="_blank">node_redis</a></li>
</ul>
有了这些之后要用javascript开发一个web app相对容易多了。

这两天简单试了下，用express, hamljs, node-mongodb-native写了一个最简单的blog app.

安装环境
<ul>
	<li>install node [code language="bash"] #download source code from http://nodejs.org/dist/
 wget http://nodejs.org/dist/node-v0.4.5.tar.gz
tar -xf node-v0.4.5.tar.gz
cd node-v0.4.5
./configure &amp;&amp; make &amp;&amp; sudo make install
[/code]</li>
	<li>install mongodb
[code language="bash"] #http://www.mongodb.org/downloads
wget http://fastdl.mongodb.org/linux/mongodb-linux-i686-1.8.1.tgz
tar -xf mongodb-linux-i686-1.8.1.tgz
cd mongodb-linux-i686-1.8.1
sudo mkdir -p /data/db
sudo chown `id -u` -R /data
bin/mongod # start mongodb server
[/code]</li>
	<li>install npm [code language="bash"]git clone http://github.com/isaacs/npm.git
cd npm
sudo make install
[/code]</li>
	<li>install modules [code language="bash"] sudo npm install express
sudo npm install hamljs
sudo npm install mongodb
[/code]</li>
</ul>
express指南见<a href="http://expressjs.com/guide.html" target="_blank">http://expressjs.com/guide.html</a>，它的route方式跟rails比算很弱的，没有对restful的直接支持，但在加上methodOverride后都可以自己定义出来。
模板引擎用hamljs, 通过app.register('.haml', require('hamljs'))指定。在hamljs layout里要嵌入其它模板内容时可以用!= body。partial可以用!= partial("post.haml", posts)。!=的意思是对后面的内容不作escape, 细节可以看hamljs代码，很短，不到700行。
mongodb client用起来比较费劲，一层一层的callback, 适当封装下应该会好使点。
最终的代码放在<a href="https://github.com/nodepress/draft">https://github.com/nodepress/draft</a>
性能看起来还是很好的，production模式下(NODE_ENV=production node blog.js) 并发５个连接(ab -c 5 -n 1000 http://localhost:3000/posts/)的结果
Time per request:       1.145 [ms] (mean, across all concurrent requests)
{% codeblock %}$ ab -c 5 -n 1000 http://localhost:3000/posts/
....
Server Software:        
Server Hostname:        localhost
Server Port:            3000

Document Path:          /posts/
Document Length:        2950 bytes

Concurrency Level:      5
Time taken for tests:   1.145 seconds
Complete requests:      1000
Failed requests:        0
Write errors:           0
Total transferred:      3073000 bytes
HTML transferred:       2950000 bytes
Requests per second:    873.02 [#/sec] (mean)
Time per request:       5.727 [ms] (mean)
Time per request:       1.145 [ms] (mean, across all concurrent requests)
Transfer rate:          2619.90 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.0      0       0
Processing:     3    6   1.8      5      22
Waiting:        3    6   1.8      5      22
Total:          3    6   1.8      5      22

Percentage of the requests served within a certain time (ms)
  50%      5
  66%      5
  75%      6
  80%      6
  90%      7
  95%      8
  98%     14
  99%     16
 100%     22 (longest request){% endcodeblock %}
