<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[zzzhc's Blog]]></title>
  <link href="http://blog.zzzhc.com/atom.xml" rel="self"/>
  <link href="http://blog.zzzhc.com/"/>
  <updated>2011-12-16T17:20:48+08:00</updated>
  <id>http://blog.zzzhc.com/</id>
  <author>
    <name><![CDATA[zzzhc]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ack - better grep]]></title>
    <link href="http://blog.zzzhc.com/posts/2011-12-16-ack-better-grep/"/>
    <updated>2011-12-16T16:40:00+08:00</updated>
    <id>http://blog.zzzhc.com/posts/ack-better-grep</id>
    <content type="html"><![CDATA[<p><a href="http://betterthangrep.com/">Ack</a>是一个给程序员用的grep, 使用perl regular expressions, 而不是POSIX/GNU subset.</p>

<h2>why ack?</h2>

<ul>
<li>使用perl regular expressions, 忘掉grep那套不人性的pattern吧</li>
<li>速度快, 默认只搜索程序代码文件</li>
<li>自动忽略.svn, .git, CVS这类目录, 默认递归搜索子目录</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># with grep</span>
</span><span class='line'><span class="nv">$ </span>grep pattern <span class="k">$(</span>find . -type f | grep -v <span class="s1">&#39;\.svn&#39;</span><span class="k">)</span>
</span><span class='line'>or
</span><span class='line'><span class="nv">$ </span>grep -R --exclude-dir .svn pattern
</span><span class='line'><span class="c"># with ack</span>
</span><span class='line'><span class="nv">$ </span>ack pattern
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>支持搜索指定文件类型</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 只搜索ruby code</span>
</span><span class='line'><span class="nv">$ </span>ack --ruby pattern
</span></code></pre></td></tr></table></div></figure>


<h2>install</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># mac</span>
</span><span class='line'><span class="nv">$ </span>brew install ack
</span><span class='line'><span class="c"># ubuntu</span>
</span><span class='line'><span class="nv">$ </span>sudo apt-get install ack-grep
</span></code></pre></td></tr></table></div></figure>


<h2>integrate into vim</h2>

<ul>
<li>install <a href="https://github.com/mileszs/ack.vim">ack.vim</a></li>
<li>set grepprg=ack in vimrc</li>
</ul>


<h2>custom ack</h2>

<p>Ack默认包含很多filetype => extensions的设置，但新出现的语言不一定支持。好在ack提供<code>--type-add TYPE=.EXTENSION[,.EXT2[,...]]</code>, <code>--type-set TYPE=.EXTENSION[,.EXT2[,...]]</code>来扩展。经常用的可以加到~/.ackrc里, 我的.ackrc:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat ~/.ackrc
</span><span class='line'>--type-add
</span><span class='line'><span class="nv">ruby</span><span class="o">=</span>.haml,.ru
</span><span class='line'>--type-add
</span><span class='line'><span class="nv">css</span><span class="o">=</span>.scss,.sass,.less
</span><span class='line'>--type-add
</span><span class='line'><span class="nv">js</span><span class="o">=</span>.coffee
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[有道字典 chrome extension]]></title>
    <link href="http://blog.zzzhc.com/posts/2011-12-12-you-dao-zi-dian-httpjie-kou/"/>
    <updated>2011-12-12T11:17:00+08:00</updated>
    <id>http://blog.zzzhc.com/posts/you-dao-zi-dian-httpjie-kou</id>
    <content type="html"><![CDATA[<p>有道字典的chrome extension会把鼠标下的词log到console里，debug的时候让人烦, 看了下code, 直接用的console.log, 发布的时候也没注释掉. 跑到~/Library/Application Support/Google/Chrome/Default/Extensions/nbndkplefmmhmcmfjanjaakhhkiegogd/1.0_0下把content.js,background.html里的console.log都注释掉，安静了。</p>

<p>大概看了下extension code, 发现两个有意思的地方：</p>

<ul>
<li>打包的时候连.svn目录都没放过</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>svn info
</span><span class='line'>Path: .
</span><span class='line'>URL: https://dev.corp.youdao.com/svn/outfox/products/desktop/incubator/mac/GetWordExtension/Chrome/extension
</span><span class='line'>Repository Root: https://dev.corp.youdao.com/svn/outfox
</span><span class='line'>Repository UUID: 36a6777f-fe3c-0410-890b-904d6044f29d
</span><span class='line'>Revision: 285097
</span><span class='line'>Node Kind: directory
</span><span class='line'>Schedule: normal
</span><span class='line'>Last Changed Author: huangdx
</span><span class='line'>Last Changed Rev: 277738
</span><span class='line'>Last Changed Date: 2011-09-13 14:00:17 +0800 <span class="o">(</span>二, 13  9 2011<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>取词的时候调用的是本机有道字典app提供的http接口</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//in background.html</span>
</span><span class='line'>     <span class="kd">function</span> <span class="nx">SendResult</span><span class="p">(</span><span class="nx">word</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span>
</span><span class='line'>         <span class="nx">s</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;http://localhost:32445/getword?word=&quot;</span> <span class="o">+</span> <span class="nx">word</span> <span class="o">+</span> <span class="s2">&quot;&amp;pos=&quot;</span> <span class="o">+</span> <span class="nx">pos</span> <span class="o">+</span> <span class="s2">&quot;&amp;type=&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>         <span class="c1">//console.log(&#39;sending...&#39;)</span>
</span><span class='line'>         <span class="nx">s</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
</span><span class='line'>     <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>用curl试了下，可以发送请求，但响应为空</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -vv <span class="s1">&#39;http://localhost:32445/getword?word=for%20suppliers&amp;pos=8&amp;type=0&#39;</span>
</span><span class='line'>* About to connect<span class="o">()</span> to localhost port 32445 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>*   Trying ::1... Connection refused
</span><span class='line'>*   Trying 127.0.0.1... connected
</span><span class='line'>* Connected to localhost <span class="o">(</span>127.0.0.1<span class="o">)</span> port 32445 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>&gt; GET /getword?word<span class="o">=</span><span class="k">for</span>%20suppliers&amp;pos<span class="o">=</span>8&amp;type<span class="o">=</span>0 HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.21.4 <span class="o">(</span>universal-apple-darwin11.0<span class="o">)</span> libcurl/7.21.4 OpenSSL/0.9.8r zlib/1.2.5
</span><span class='line'>&gt; Host: localhost:32445
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>* Empty reply from server
</span><span class='line'>* Connection <span class="c">#0 to host localhost left intact</span>
</span><span class='line'>curl: <span class="o">(</span>52<span class="o">)</span> Empty reply from server
</span><span class='line'>* Closing connection <span class="c">#0</span>
</span></code></pre></td></tr></table></div></figure>


<p>word, pos, type这三个参数只要少一个有道字典就会crash</p>

<p>这次http request只是一个trigger, 有道字典会向dict.youdao.com发一个request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -vv <span class="s1">&#39;http://dict.youdao.com/fsearch?q=for%20suppliers&amp;pos=8&amp;keyfrom=mac.scrtrans.0&amp;id=E33EC7736AFDCABB184051CD3757CA73&amp;vendor=cidian.youdao.com&amp;client=macdict&#39;</span>
</span><span class='line'>* About to connect<span class="o">()</span> to dict.youdao.com port 80 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>*   Trying 61.135.218.32... connected
</span><span class='line'>* Connected to dict.youdao.com <span class="o">(</span>61.135.218.32<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>&gt; GET /fsearch?q<span class="o">=</span><span class="k">for</span>%20suppliers&amp;pos<span class="o">=</span>8&amp;keyfrom<span class="o">=</span>mac.scrtrans.0&amp;id<span class="o">=</span>E33EC7736AFDCABB184051CD3757CA73&amp;vendor<span class="o">=</span>cidian.youdao.com&amp;client<span class="o">=</span>macdict HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.21.4 <span class="o">(</span>universal-apple-darwin11.0<span class="o">)</span> libcurl/7.21.4 OpenSSL/0.9.8r zlib/1.2.5
</span><span class='line'>&gt; Host: dict.youdao.com
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>&lt; HTTP/1.1 200 OK
</span><span class='line'>&lt; Server: nginx
</span><span class='line'>&lt; Date: Tue, 13 Dec 2011 07:10:55 GMT
</span><span class='line'>&lt; Content-Type: text/xml; <span class="nv">charset</span><span class="o">=</span>utf-8
</span><span class='line'>&lt; Connection: keep-alive
</span><span class='line'>&lt; Cache-Control: private
</span><span class='line'>&lt; Content-Language: en-US
</span><span class='line'>&lt; Set-Cookie: <span class="nv">OUTFOX_SEARCH_USER_ID</span><span class="o">=</span>-447518408@123.117.56.163; <span class="nv">domain</span><span class="o">=</span>.youdao.com; <span class="nv">expires</span><span class="o">=</span>Thu, 05-Dec-2041 07:10:55 GMT
</span><span class='line'>&lt; Set-Cookie: <span class="nv">JSESSIONID</span><span class="o">=</span>abcdjNBcCWPPK4igOq2qt; <span class="nv">domain</span><span class="o">=</span>youdao.com; <span class="nv">path</span><span class="o">=</span>/
</span><span class='line'>&lt; Vary: Accept-Encoding
</span><span class='line'>&lt; Content-Length: 1477
</span><span class='line'>&lt;
</span><span class='line'>&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>?&gt;
</span><span class='line'>
</span><span class='line'>&lt;yodaodict&gt;
</span><span class='line'>  &lt;<span class="k">return</span>-phrase&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>suppliers<span class="o">]]</span>&gt;&lt;/return-phrase&gt;
</span><span class='line'>
</span><span class='line'>                            &lt;phonetic-symbol&gt;sə<span class="err">&#39;</span>plaiəz&lt;/phonetic-symbol&gt;
</span><span class='line'>                  &lt;dictcn-speach&gt;suppliers&lt;/dictcn-speach&gt;
</span><span class='line'>                          &lt;custom-translation&gt;
</span><span class='line'>        &lt;<span class="nb">type</span>&gt;ec&lt;/type&gt;
</span><span class='line'>                  &lt;translation&gt;&lt;content&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>n. 供应商（supplier的复数）<span class="o">]]</span>&gt;&lt;/content&gt;&lt;/translation&gt;
</span><span class='line'>                &lt;/custom-translation&gt;
</span><span class='line'>
</span><span class='line'>              &lt;yodao-web-dict&gt;
</span><span class='line'>                    &lt;web-translation&gt;
</span><span class='line'>                &lt;key&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>Suppliers<span class="o">]]</span>&gt;&lt;/key&gt;
</span><span class='line'>                          &lt;trans&gt;&lt;value&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>供应商<span class="o">]]</span>&gt;&lt;/value&gt;&lt;/trans&gt;
</span><span class='line'>                  &lt;trans&gt;&lt;value&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>供货商<span class="o">]]</span>&gt;&lt;/value&gt;&lt;/trans&gt;
</span><span class='line'>                  &lt;trans&gt;&lt;value&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>数据库<span class="o">]]</span>&gt;&lt;/value&gt;&lt;/trans&gt;
</span><span class='line'>                &lt;/web-translation&gt;
</span><span class='line'>              &lt;web-translation&gt;
</span><span class='line'>                &lt;key&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>Overview Suppliers<span class="o">]]</span>&gt;&lt;/key&gt;
</span><span class='line'>                          &lt;trans&gt;&lt;value&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>概览<span class="o">]]</span>&gt;&lt;/value&gt;&lt;/trans&gt;
</span><span class='line'>                  &lt;trans&gt;&lt;value&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>供应商<span class="o">]]</span>&gt;&lt;/value&gt;&lt;/trans&gt;
</span><span class='line'>                &lt;/web-translation&gt;
</span><span class='line'>              &lt;web-translation&gt;
</span><span class='line'>                &lt;key&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span><span class="k">select </span>suppliers<span class="o">]]</span>&gt;&lt;/key&gt;
</span><span class='line'>                          &lt;trans&gt;&lt;value&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>挑选供应商<span class="o">]]</span>&gt;&lt;/value&gt;&lt;/trans&gt;
</span><span class='line'>                &lt;/web-translation&gt;
</span><span class='line'>            &lt;/yodao-web-dict&gt;
</span><span class='line'>
</span><span class='line'>                               &lt;recommend&gt;&lt;!<span class="o">[</span>CDATA<span class="o">[</span>supplier<span class="o">]]</span>&gt;&lt;/recommend&gt;
</span><span class='line'>                    &lt;sexp&gt;0&lt;/sexp&gt;
</span><span class='line'>&lt;/yodaodict&gt;
</span><span class='line'>* Connection <span class="c">#0 to host dict.youdao.com left intact</span>
</span><span class='line'>* Closing connection <span class="c">#0</span>
</span></code></pre></td></tr></table></div></figure>


<p>拿到结果后由有道字典显示一个提示窗口.</p>

<p>这种实现方式倒也算精巧, 其他app要用这个http接口也比较方便，只是32445端口连个http 200都不返回粗暴了点.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[speed up rails asset pipeline]]></title>
    <link href="http://blog.zzzhc.com/posts/2011-12-11-speed-up-rails-asset-pipeline/"/>
    <updated>2011-12-11T20:48:00+08:00</updated>
    <id>http://blog.zzzhc.com/posts/speed-up-rails-asset-pipeline</id>
    <content type="html"><![CDATA[<p><a href="http://guides.rubyonrails.org/asset_pipeline.html">Asset pipeline</a>是Rails 3.1里引入的一个特性, 用来帮助拼接，压缩js/css,同时对缓存asset提供了更好的支持.</p>

<p>Asset pipe本身只是对<a href="https://github.com/sstephenson/sprockets">Sprockets</a>做了一层封装, 通过<code>Rails.application.assets</code>可以得到Sprockets自己的rack app.</p>

<p>如果application.js里用到了一堆的js, 在development模式下会发现页面很慢, 即使用了<a href="https://github.com/paneq/active_reload">active_reload</a>来加速.在chrome console里看下network tab，每次js请求都在100ms以上。慢的原因在于每次请求都要过一次Rails/application里定义的middleware, 跳过这些middleware之后就快多了. 改下config.ru, 世界又和谐了:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># This file is used by Rack-based servers to start the application.</span>
</span><span class='line'><span class="nb">require</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../config/environment&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">map</span> <span class="s1">&#39;/assets&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">assets</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">assets</span>
</span><span class='line'>  <span class="n">run</span> <span class="n">assets</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">map</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">run</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[高效能文本编辑的7个习惯]]></title>
    <link href="http://blog.zzzhc.com/posts/2011-12-10-gao-xiao-neng-wen-ben-bian-ji-de-7ge-xi-guan/"/>
    <updated>2011-12-10T12:59:00+08:00</updated>
    <id>http://blog.zzzhc.com/posts/gao-xiao-neng-wen-ben-bian-ji-de-7ge-xi-guan</id>
    <content type="html"><![CDATA[<p><a href="http://www.moolenaar.net/habits.html">Seven habits of effective text editing</a></p>

<h2>编辑单个文件</h2>

<h3>1. 快速移动</h3>

<ul>
<li>查找光标下单词在当前文件的其它位置

<ol>
<li>* 向后查找</li>
<li># 向前查找</li>
</ol>
</li>
<li>搜索文本, /pattern</li>
<li>使用%跳转到对应块的结尾/开头，安装<a href="http://www.vim.org/scripts/script.php?script_id=39">matchit</a>插件效果更好</li>
<li>使用gd跳转到变量定义</li>
</ul>


<p>掌握更多高效编辑命令的三个基本步骤:
* 留意编辑过程中的重复动作和花时间较多的地方
* 找出一个可以更快完成这些操作的命令
* 反复练习，直到形成习惯，不需要思考靠直觉就能敲出命令</p>

<h3>2. 不要重复输入两次</h3>

<ul>
<li>善用.命令重做前一个修改</li>
<li>使用自动补全, 安装<a href="https://github.com/ervandew/supertab">supertab</a>后可用tab键补全</li>
<li>录制宏, qa开始录制，q结束宏, @a重放宏</li>
</ul>


<h3>3. 自动修复拼写错误</h3>

<ul>
<li>abbr</li>
<li>syntax hightlight</li>
</ul>


<h2>编辑多个文件</h2>

<h3>4. 很少只在单独一个文件上工作</h3>

<ul>
<li>ctags, Ctrl+] 跳转到定义处</li>
<li>:grep, :cn</li>
</ul>


<h3>5. 与其它程序协同工作</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:!command</span></code></pre></td></tr></table></div></figure>


<h3>6. Text is structured</h3>

<p>自动化编译，修改过程</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:make
</span><span class='line'>:set errorformat=xxx</span></code></pre></td></tr></table></div></figure>


<h2>磨快你的矩</h2>

<h3>7. 养成习惯</h3>

<p>这一点最重要，花大把时间找到合适的命令但很快就忘掉是很不划算的。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[crontab tips]]></title>
    <link href="http://blog.zzzhc.com/posts/2011-12-10-crontab-tips/"/>
    <updated>2011-12-10T12:02:00+08:00</updated>
    <id>http://blog.zzzhc.com/posts/crontab-tips</id>
    <content type="html"><![CDATA[<h2>crontab command</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 设置编辑器</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">EDITOR</span><span class="o">=</span>vim
</span><span class='line'><span class="c"># 编辑</span>
</span><span class='line'><span class="nv">$ </span>crontab -e <span class="o">[</span>-u user<span class="o">]</span>
</span><span class='line'><span class="c"># 列出crontab内容</span>
</span><span class='line'><span class="nv">$ </span>crontab -l <span class="o">[</span>-u user<span class="o">]</span>
</span><span class='line'><span class="c"># 删除crontab文件</span>
</span><span class='line'><span class="nv">$ </span>crontab -r <span class="o">[</span>-u user<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>crontab syntax</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>* * * * *  <span class="nb">command</span>
</span><span class='line'>| | | | |
</span><span class='line'>| | | | |- day of week<span class="o">(</span>0-6<span class="o">)</span> 0 means sunday
</span><span class='line'>| | | |--- month<span class="o">(</span>1-12<span class="o">)</span>
</span><span class='line'>| | |----- day of month<span class="o">(</span>1-31<span class="o">)</span>
</span><span class='line'>| |------- hour
</span><span class='line'>|--------- minute<span class="o">(</span>0-59<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>* 表示的项可以用,分隔指定多个值<span class="o">(</span>如5,15,25<span class="o">)</span>，也可以指定周期，如在minute项上写*/5表示每5分钟执行一次
</span></code></pre></td></tr></table></div></figure>


<h2>crontab environment</h2>

<p>cron脚本执行的环境跟正常用户执行的有区别，~/.bashrc不会被执行, 这一点经常会引起问题, 可以在crontab里设置环境变量来减少影响.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># PATH, SHELL, MAILTO比较常用, 如</span>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/bin:/usr/sbin:/bin:/sbin
</span><span class='line'><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
</span><span class='line'><span class="nv">MAILTO</span><span class="o">=</span>xxx@xxx.com
</span><span class='line'>
</span><span class='line'>1 * * * * find /var/data/upload/ -mtime 30 -exec rm -- <span class="o">{}</span> +
</span></code></pre></td></tr></table></div></figure>


<p>默认情况crontab按OS时区调度, 而不是用户时区，可以通过指定TZ环境变量设实际要用的时区</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">TZ</span><span class="o">=</span>UTC
</span><span class='line'>1 * * * * find /var/data/upload/ -mtime 30 -exec rm -- <span class="o">{}</span> +
</span></code></pre></td></tr></table></div></figure>


<h1>crontab notification</h1>

<p>如果command有输出(stdout/stderr)，crond会发送通知邮件, 具体发送给谁可以通过MAILTO定义，默认发送给当前用户。
一般情况stdout可以忽略，所以经常会看到crontab里有 command >/dev/null; stderr一定不要忽略，否则cron job有错误无法正常执行都不知道。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[bash tips - 0]]></title>
    <link href="http://blog.zzzhc.com/posts/2011-12-09-bash-tips-0/"/>
    <updated>2011-12-09T20:18:00+08:00</updated>
    <id>http://blog.zzzhc.com/posts/bash-tips-0</id>
    <content type="html"><![CDATA[<ul>
<li>为变量设置缺省值</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>: <span class="k">${</span><span class="nv">BIND_PORT</span><span class="p">:=9999</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>取得前一个在后台运行的进程pid</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sleep 10 &amp;
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$!</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>当前脚本的绝对路径</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">SCRIPT_PATH</span><span class="o">=</span><span class="sb">`</span>readlink -f <span class="s2">&quot;$0&quot;</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rvm global gems]]></title>
    <link href="http://blog.zzzhc.com/posts/2011-12-09-rvm-global-gems/"/>
    <updated>2011-12-09T19:07:00+08:00</updated>
    <id>http://blog.zzzhc.com/posts/rvm-global-gems</id>
    <content type="html"><![CDATA[<p>用rvm安装多了ruby版本后，一些经常用的gem需要在多个版本下都重装一次，很费事。不过还好rvm早有<a href="http://beginrescueend.com/gemsets/initial/">解决方案</a>，可以通过编辑~/.rvm/gemsets/global.gems来添加全局的gemsets, 比如必不可少的bundler</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundler</span></code></pre></td></tr></table></div></figure>


<p>也可以指定版本</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundler -v~&gt;1.0.21</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[lucene 3下最快的中文分词器]]></title>
    <link href="http://blog.zzzhc.com/blogs/115"/>
    <updated>2011-06-19T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/115</id>
    <content type="html"><![CDATA[<h1>包包分词器 - 一个基于字典的快速中文分词器</h1>

<h2>source code</h2>

<ul>
<li><a href="https://github.com/zzzhc/baobao-analyzer">github project</a></li>
</ul>


<h2>features</h2>

<ul>
<li>简单 1000LOC</li>
<li>高效 7M+ chars/second</li>
<li>支持中文，英语，数字</li>
<li>自动识别未登录词</li>
<li>支持OffsetAttribute</li>
<li>支持TypeAttribute</li>
<li>支持PositionIncrementAttribute</li>
</ul>


<h2>usage</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Dict</span> <span class="n">dict</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Dict</span><span class="o">();</span>
</span><span class='line'><span class="n">dict</span><span class="o">.</span><span class="na">addAllSpecialTypes</span><span class="o">();</span>
</span><span class='line'><span class="n">BufferedReader</span> <span class="n">dictReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="s">&quot;dict.txt&quot;</span><span class="o">),</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">dict</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">dictReader</span><span class="o">);</span>
</span><span class='line'><span class="n">dictReader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'><span class="n">dict</span><span class="o">.</span><span class="na">optimize</span><span class="o">();</span>
</span><span class='line'><span class="n">DictAnalyzer</span> <span class="n">dictAnalyzer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DictAnalyzer</span><span class="o">(</span><span class="n">dict</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>benchmark</h2>

<p>ant benchmark</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">supported</span> <span class="nl">features:</span>
</span><span class='line'>                  <span class="n">CharTerm</span>  <span class="n">Offset</span>  <span class="n">PositionIncrement</span>  <span class="n">Term</span>  <span class="n">Type</span>
</span><span class='line'>      <span class="n">IKAnalyzer</span>         <span class="n">Y</span>       <span class="n">Y</span>                  <span class="n">N</span>     <span class="n">Y</span>     <span class="n">N</span>
</span><span class='line'>   <span class="n">MMSegAnalyzer</span>         <span class="n">Y</span>       <span class="n">Y</span>                  <span class="n">N</span>     <span class="n">Y</span>     <span class="n">Y</span>
</span><span class='line'> <span class="n">PaodingAnalyzer</span>         <span class="n">Y</span>       <span class="n">Y</span>                  <span class="n">N</span>     <span class="n">Y</span>     <span class="n">Y</span>
</span><span class='line'><span class="n">StandardAnalyzer</span>         <span class="n">Y</span>       <span class="n">Y</span>                  <span class="n">Y</span>     <span class="n">Y</span>     <span class="n">Y</span>
</span><span class='line'>  <span class="n">BaoBaoAnalyzer</span>         <span class="n">Y</span>       <span class="n">Y</span>                  <span class="n">Y</span>     <span class="n">Y</span>     <span class="n">Y</span>
</span><span class='line'>
</span><span class='line'><span class="n">test</span> <span class="mi">1</span><span class="o">,</span> <span class="n">sample</span> <span class="n">length</span><span class="o">=</span><span class="mi">26265</span>
</span><span class='line'>            <span class="n">name</span>          <span class="n">chars</span>           <span class="n">time</span>         <span class="n">tokens</span> <span class="nf">speed</span><span class="o">(</span><span class="n">chars</span><span class="o">/</span><span class="n">second</span><span class="o">)</span>
</span><span class='line'> <span class="n">PaodingAnalyzer</span>          <span class="mi">26265</span>          <span class="mf">0.610</span>          <span class="mi">12542</span>            <span class="mf">43036.87</span>
</span><span class='line'>   <span class="n">MMSegAnalyzer</span>          <span class="mi">26265</span>          <span class="mf">0.314</span>          <span class="mi">14007</span>            <span class="mf">83566.52</span>
</span><span class='line'>      <span class="n">IKAnalyzer</span>          <span class="mi">26265</span>          <span class="mf">0.262</span>          <span class="mi">16016</span>           <span class="mf">100177.91</span>
</span><span class='line'><span class="n">StandardAnalyzer</span>          <span class="mi">26265</span>          <span class="mf">0.141</span>          <span class="mi">22366</span>           <span class="mf">185727.87</span>
</span><span class='line'>  <span class="n">BaoBaoAnalyzer</span>          <span class="mi">26265</span>          <span class="mf">0.038</span>          <span class="mi">18185</span>           <span class="mf">695682.16</span>
</span><span class='line'>
</span><span class='line'><span class="n">test</span> <span class="mi">2</span><span class="o">,</span> <span class="n">sample</span> <span class="n">length</span><span class="o">=</span><span class="mi">262650</span>
</span><span class='line'>            <span class="n">name</span>          <span class="n">chars</span>           <span class="n">time</span>         <span class="n">tokens</span> <span class="nf">speed</span><span class="o">(</span><span class="n">chars</span><span class="o">/</span><span class="n">second</span><span class="o">)</span>
</span><span class='line'> <span class="n">PaodingAnalyzer</span>         <span class="mi">262650</span>          <span class="mf">0.187</span>         <span class="mi">125420</span>          <span class="mf">1402139.61</span>
</span><span class='line'>      <span class="n">IKAnalyzer</span>         <span class="mi">262650</span>          <span class="mf">0.163</span>         <span class="mi">160160</span>          <span class="mf">1613693.16</span>
</span><span class='line'>   <span class="n">MMSegAnalyzer</span>         <span class="mi">262650</span>          <span class="mf">0.158</span>         <span class="mi">140070</span>          <span class="mf">1664009.53</span>
</span><span class='line'>  <span class="n">BaoBaoAnalyzer</span>         <span class="mi">262650</span>          <span class="mf">0.041</span>         <span class="mi">181850</span>          <span class="mf">6362134.44</span>
</span><span class='line'><span class="n">StandardAnalyzer</span>         <span class="mi">262650</span>          <span class="mf">0.020</span>         <span class="mi">223660</span>         <span class="mf">12905789.80</span>
</span><span class='line'>
</span><span class='line'><span class="n">test</span> <span class="mi">3</span><span class="o">,</span> <span class="n">sample</span> <span class="n">length</span><span class="o">=</span><span class="mi">2626500</span>
</span><span class='line'>            <span class="n">name</span>          <span class="n">chars</span>           <span class="n">time</span>         <span class="n">tokens</span> <span class="nf">speed</span><span class="o">(</span><span class="n">chars</span><span class="o">/</span><span class="n">second</span><span class="o">)</span>
</span><span class='line'>      <span class="n">IKAnalyzer</span>        <span class="mi">2626500</span>          <span class="mf">2.251</span>        <span class="mi">1601600</span>          <span class="mf">1166564.72</span>
</span><span class='line'> <span class="n">PaodingAnalyzer</span>        <span class="mi">2626500</span>          <span class="mf">1.462</span>        <span class="mi">1254200</span>          <span class="mf">1796381.55</span>
</span><span class='line'>   <span class="n">MMSegAnalyzer</span>        <span class="mi">2626500</span>          <span class="mf">1.043</span>        <span class="mi">1400700</span>          <span class="mf">2519010.94</span>
</span><span class='line'>  <span class="n">BaoBaoAnalyzer</span>        <span class="mi">2626500</span>          <span class="mf">0.352</span>        <span class="mi">1818500</span>          <span class="mf">7458959.20</span>
</span><span class='line'><span class="n">StandardAnalyzer</span>        <span class="mi">2626500</span>          <span class="mf">0.202</span>        <span class="mi">2236600</span>         <span class="mf">13015280.16</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[mysqld 5.1.41的一个神奇bug]]></title>
    <link href="http://blog.zzzhc.com/blogs/107"/>
    <updated>2011-06-09T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/107</id>
    <content type="html"><![CDATA[<p>今天打算在本地装两个数据库，方便测试，用mysql_install_db &#8211;datadir=/opt/mysql初始化mysql data directory, 死活都不成功，/opt, /opt/mysql的权限都改成0777也是一样</p>

<p>OS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/lsb-release
</span><span class='line'><span class="nv">DISTRIB_ID</span><span class="o">=</span>Ubuntu
</span><span class='line'><span class="nv">DISTRIB_RELEASE</span><span class="o">=</span>10.04
</span><span class='line'><span class="nv">DISTRIB_CODENAME</span><span class="o">=</span>lucid
</span><span class='line'><span class="nv">DISTRIB_DESCRIPTION</span><span class="o">=</span><span class="s2">&quot;Ubuntu 10.04.1 LTS&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mysql_install_db --datadir<span class="o">=</span>/opt/mysql/
</span><span class='line'>Installing MySQL system tables...
</span><span class='line'>110609 20:59:26 <span class="o">[</span>Warning<span class="o">]</span> Can<span class="s1">&#39;t create test file /opt/mysql/zzzhc-laptop.lower-test</span>
</span><span class='line'><span class="s1">110609 20:59:26 [Warning] Can&#39;</span>t create <span class="nb">test </span>file /opt/mysql/zzzhc-laptop.lower-test
</span><span class='line'>
</span><span class='line'>Installation of system tables failed!  Examine the logs in
</span><span class='line'>/opt/mysql/ <span class="k">for </span>more information.
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>换成/tmp目录,mysql_install_db &#8211;datadir=/tmp，神奇地成功了。</p>

<p>bash -x mysql_install_db &#8211;datadir=/opt/mysql/发现问题在这:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>+ <span class="nv">mysqld_install_cmd_line</span><span class="o">=</span><span class="s1">&#39;/usr/sbin/mysqld  --language=/usr/share/mysql/english --bootstrap   --basedir=/usr --datadir=/opt/mysql/ --log-warnings=0 --loose-skip-innodb   --loose-skip-ndbcluster  --user=mysql --max_allowed_packet=8M   --default-storage-engine=myisam   --net_buffer_length=16K&#39;</span>
</span><span class='line'>+ s_echo <span class="s1">&#39;Installing MySQL system tables...&#39;</span>
</span><span class='line'>+ <span class="nb">test </span>0 -eq 0 -a 0 -eq 0
</span><span class='line'>+ <span class="nb">echo</span> <span class="s1">&#39;Installing MySQL system tables...&#39;</span>
</span><span class='line'>Installing MySQL system tables...
</span><span class='line'>+ /usr/sbin/mysqld --language<span class="o">=</span>/usr/share/mysql/english --bootstrap --basedir<span class="o">=</span>/usr --datadir<span class="o">=</span>/opt/mysql/ --log-warnings<span class="o">=</span>0 --loose-skip-innodb --loose-skip-ndbcluster --user<span class="o">=</span>mysql --max_allowed_packet<span class="o">=</span>8M --default-storage-engine<span class="o">=</span>myisam --net_buffer_length<span class="o">=</span>16K
</span><span class='line'>+ <span class="nb">echo</span> <span class="s1">&#39;use mysql;&#39;</span>
</span><span class='line'>+ cat /usr/share/mysql/mysql_system_tables.sql /usr/share/mysql/mysql_system_tables_data.sql
</span><span class='line'>110609 21:04:14 <span class="o">[</span>Warning<span class="o">]</span> Can<span class="s1">&#39;t create test file /opt/mysql/zzzhc-laptop.lower-test</span>
</span><span class='line'><span class="s1">110609 21:04:14 [Warning] Can&#39;</span>t create <span class="nb">test </span>file /opt/mysql/zzzhc-laptop.lower-test
</span><span class='line'>+ <span class="nb">eval </span>cat
</span><span class='line'>++ cat
</span><span class='line'>+ <span class="nb">echo</span>
</span><span class='line'>
</span><span class='line'>+ <span class="nb">echo</span> <span class="s1">&#39;Installation of system tables failed!  Examine the logs in&#39;</span>
</span><span class='line'>Installation of system tables failed!  Examine the logs in
</span><span class='line'>+ <span class="nb">echo</span> <span class="s1">&#39;/opt/mysql/ for more information.&#39;</span>
</span><span class='line'>/opt/mysql/ <span class="k">for </span>more information.
</span></code></pre></td></tr></table></div></figure>


<p>strace /usr/sbin/mysqld &#8211;language=/usr/share/mysql/english &#8211;bootstrap &#8211;basedir=/usr &#8211;datadir=/opt/mysql/ &#8211;log-warnings=0 &#8211;loose-skip-innodb &#8211;loose-skip-ndbcluster &#8211;user=mysql &#8211;max_allowed_packet=8M &#8211;default-storage-engine=myisam &#8211;net_buffer_length=16K 2>&amp;1 |tee strace.log</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>stat64<span class="o">(</span><span class="s2">&quot;/usr/share/mysql/charsets/Index.xml&quot;</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG|0644, <span class="nv">st_size</span><span class="o">=</span>18261, ...<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>brk<span class="o">(</span>0x22064000<span class="o">)</span>                         <span class="o">=</span> 0x22064000
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/usr/share/mysql/charsets/Index.xml&quot;</span>, O_RDONLY|O_LARGEFILE<span class="o">)</span> <span class="o">=</span> 3
</span><span class='line'><span class="nb">read</span><span class="o">(</span>3, <span class="s2">&quot;..., 18261) = 18261</span>
</span><span class='line'><span class="s2">close(3)                                = 0 </span>
</span><span class='line'><span class="s2">unlink(&quot;</span>/opt/mysql/zzzhc-laptop.LOWER-TEST<span class="s2">&quot;) = -1 ENOENT (No such file or directory)</span>
</span><span class='line'><span class="s2">open(&quot;</span>/opt/mysql/zzzhc-laptop.lower-test<span class="s2">&quot;, O_RDWR|O_CREAT|O_LARGEFILE, 0666) = -1 EACCES (Permission denied)</span>
</span><span class='line'><span class="s2">time(NULL)                              = 1307624820</span>
</span><span class='line'><span class="s2">write(2, &quot;</span>110609 21:07:00 <span class="o">[</span>Warning<span class="o">]</span> Can<span class="s1">&#39;t &quot;..., 84110609 21:07:00 [Warning] Can&#39;</span>t create <span class="nb">test </span>file /opt/mysql/zzzhc-laptop.lower-test
</span><span class='line'><span class="o">)</span> <span class="o">=</span> 84
</span><span class='line'>unlink<span class="o">(</span><span class="s2">&quot;/opt/mysql/zzzhc-laptop.LOWER-TEST&quot;</span><span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/opt/mysql/zzzhc-laptop.lower-test&quot;</span>, O_RDWR|O_CREAT|O_LARGEFILE, 0666<span class="o">)</span> <span class="o">=</span> -1 EACCES <span class="o">(</span>Permission denied<span class="o">)</span>
</span><span class='line'><span class="nb">time</span><span class="o">(</span>NULL<span class="o">)</span>                              <span class="o">=</span> 1307624820
</span><span class='line'>write<span class="o">(</span>2, <span class="s2">&quot;110609 21:07:00 [Warning] Can&#39;t &quot;</span>..., 84110609 21:07:00 <span class="o">[</span>Warning<span class="o">]</span> Can<span class="err">&#39;</span>t create <span class="nb">test </span>file /opt/mysql/zzzhc-laptop.lower-test
</span><span class='line'><span class="o">)</span> <span class="o">=</span> 84
</span></code></pre></td></tr></table></div></figure>


<p>open(&#8220;/opt/mysql/zzzhc-laptop.lower-test&#8221;, O_RDWR|O_CREAT|O_LARGEFILE, 0666) = -1 EACCES (Permission denied) 这个太没道理了。。。比较了/tmp和/opt/mysql两种情况下的strace结果，没发现什么可疑的地方，难道是/tmp目录有什么奇怪的特性??</p>

<p>0.77试了下，一切正常。
bug总是无处不在啊!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[做事]]></title>
    <link href="http://blog.zzzhc.com/blogs/101"/>
    <updated>2011-05-19T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/101</id>
    <content type="html"><![CDATA[<p>做好一件事和用正确的方法做好一件事，看起来是一样的结果，实际上如果每次做的事都留下一两个坑，几年之后会再也无法移动。
但什么是正确的方法？这也没有定论，不同的阶段会不一样。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[lucene中文分词器比较]]></title>
    <link href="http://blog.zzzhc.com/blogs/86"/>
    <updated>2011-05-03T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/86</id>
    <content type="html"><![CDATA[<h1>当前支持lucene 3.1的中文分词器</h1>

<ul>
<li><a href="http://code.google.com/p/mmseg4j/">mmseg4j</a>
mmseg4j 用 Chih-Hao Tsai 的 MMSeg 算法(http://technology.chtsai.org/mmseg/ )实现的中文分词器，并实现 lucene 的 analyzer 和 solr 的TokenizerFactory 以方便在Lucene和Solr中使用。 </li>
<li><a href="http://code.google.com/p/paoding/">paoding</a>
Paoding&#8217;s Knives 中文分词具有极 高效率 和 高扩展性 。引入隐喻，采用完全的面向对象设计，构思先进。
高效率：在PIII 1G内存个人机器上，1秒 可准确分词 100万 汉字。
采用基于 不限制个数 的词典文件对文章进行有效切分，使能够将对词汇分类定义。
能够对未知的词汇进行合理解析 </li>
<li><a href="http://code.google.com/p/ik-analyzer/">ik-analyzer</a>
IKAnalyzer是一个开源的，基于java语言开发的轻量级的中文分词工具包。从2006年12月推出1.0版开始，IKAnalyzer已经推出了3个大版本。最初，它是以开源项目Luence为应用主体的，结合词典分词和文法分析算法的中文分词组件。新版本的IKAnalyzer3.0则发展为面向Java的公用分词组件，独立于Lucene项目，同时提供了对Lucene的默认优化实现。</li>
<li><a href="http://code.google.com/p/imdict-chinese-analyzer/">imdict</a>
imdict-chinese-analyzer 是imdict智能词典的智能中文分词模块，算法基于隐马尔科夫模型(Hidden Markov Model, HMM)，是中国科学院计算技术研究所的ictclas中文分词程序的重新实现（基于Java），可以直接为lucene搜索引擎提供简体中文分词支持。 已加入lucene contributor, smartcn.</li>
</ul>


<h1>支持的特性</h1>

<table>
  <thead>
     <td>name</td>
     <td>CharTermAttribute</td>
     <td>OffsetAttribute</td>
     <td>TypeAttribute</td>
     <td>PositionIncrementAttribute</td>
     <td>KeywordAttribute</td>
  </thead>
  <tr>
     <td>mmseg4j</td>
     <td>Y</td>
     <td>Y</td>
     <td>Y</td>
     <td>N</td>
     <td>N</td>
  </tr>
  <tr>
     <td>paoding</td>
     <td>Y</td>
     <td>Y</td>
     <td>Y</td>
     <td>N</td>
     <td>N</td>
  </tr>
  <tr>
     <td>ik-analyzer</td>
     <td>Y</td>
     <td>Y</td>
     <td>N</td>
     <td>N</td>
     <td>N</td>
  </tr>
  <tr>
     <td>imdict</td>
     <td>Y</td>
     <td>Y</td>
     <td>Y</td>
     <td>N</td>
     <td>Y</td>
  </tr>
</table>


<h1>性能比较</h1>

<p>本机cpu: Intel(R) Core(TM)2 Duo CPU     P8600  @ 2.40GHz</p>

<table>
  <thead>
     <td>name</td>
     <td>speed(chars/second)</td>
  </thead>
  <tr>
     <td>StandardAnalyzer</td>
     <td>5227272</td>
  </tr>
  <tr>
     <td>mmseg4j</td>
     <td>771812</td>
  </tr>
  <tr>
     <td>paoding</td>
     <td>847145</td>
  </tr>
  <tr>
     <td>ik-analyzer</td>
     <td>657142</td>
  </tr>
  <tr>
     <td>imdict</td>
     <td>269242</td>
  </tr>
</table>


<p>测试代码:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//CNAnalyzerBenchmark.java</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.StringReader</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">net.paoding.analysis.analyzer.PaodingAnalyzer</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.lucene.analysis.Analyzer</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.lucene.analysis.TokenStream</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.lucene.analysis.cn.smart.SmartChineseAnalyzer</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.lucene.analysis.standard.StandardAnalyzer</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.lucene.util.Attribute</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.lucene.util.Version</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.wltea.analyzer.lucene.IKAnalyzer</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.chenlb.mmseg4j.analysis.MMSegAnalyzer</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CNAnalyzerBenchmark</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">IKAnalyzer</span> <span class="n">ikAnalyzer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IKAnalyzer</span><span class="o">();</span>
</span><span class='line'>        <span class="n">testAnalyzer</span><span class="o">(</span><span class="n">ikAnalyzer</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">MMSegAnalyzer</span> <span class="n">mmsegAnalyzer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MMSegAnalyzer</span><span class="o">();</span>
</span><span class='line'>        <span class="n">testAnalyzer</span><span class="o">(</span><span class="n">mmsegAnalyzer</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">PaodingAnalyzer</span> <span class="n">paodingAnalyzer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PaodingAnalyzer</span><span class="o">();</span>
</span><span class='line'>        <span class="n">testAnalyzer</span><span class="o">(</span><span class="n">paodingAnalyzer</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">SmartChineseAnalyzer</span> <span class="n">smartChineseAnalyzer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SmartChineseAnalyzer</span><span class="o">(</span>
</span><span class='line'>                <span class="n">Version</span><span class="o">.</span><span class="na">LUCENE_31</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>        <span class="n">testAnalyzer</span><span class="o">(</span><span class="n">smartChineseAnalyzer</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">StandardAnalyzer</span> <span class="n">standardAnalyzer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StandardAnalyzer</span><span class="o">(</span>
</span><span class='line'>                <span class="n">Version</span><span class="o">.</span><span class="na">LUCENE_31</span><span class="o">,</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;());</span>
</span><span class='line'>        <span class="n">testAnalyzer</span><span class="o">(</span><span class="n">standardAnalyzer</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testAnalyzer</span><span class="o">(</span><span class="n">Analyzer</span> <span class="n">a</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="s">&quot;中文(chinese)与西方语言最大的区别&quot;</span> <span class="o">+</span> <span class="s">&quot;就在于语句的词汇之间没有明显的分词界限，&quot;</span>
</span><span class='line'>                <span class="o">+</span> <span class="s">&quot;但是计算机自然语言处理是按词汇来进行分析的，&quot;</span> <span class="o">+</span> <span class="s">&quot;因此中文分词的效果直接影响中文检索和自然语言处理的准确性。&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="n">StringBuilder</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ss</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">attributes</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="n">TokenStream</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">tokenStream</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
</span><span class='line'>        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Attribute</span><span class="o">&gt;&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">stream</span>
</span><span class='line'>                <span class="o">.</span><span class="na">getAttributeClassesIterator</span><span class="o">();</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Attribute</span><span class="o">&gt;</span> <span class="n">attrClass</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span><span class='line'>            <span class="n">attributes</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">attrClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">stream</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">tokenStream</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="n">stream</span><span class="o">.</span><span class="na">incrementToken</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>               <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; attributes: &quot;</span>
</span><span class='line'>                   <span class="o">+</span> <span class="n">attributes</span><span class="o">);</span>
</span><span class='line'>               <span class="kt">double</span> <span class="n">seconds</span> <span class="o">=</span> <span class="o">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="o">;</span>
</span><span class='line'>               <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;chars=&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>                       <span class="s">&quot;,time=&quot;</span> <span class="o">+</span> <span class="n">seconds</span> <span class="o">+</span> <span class="s">&quot;seconds&quot;</span> <span class="o">+</span>
</span><span class='line'>                      <span class="s">&quot;,speed=&quot;</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">/</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;chars/second&quot;</span>
</span><span class='line'>               <span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[solr faceted search]]></title>
    <link href="http://blog.zzzhc.com/blogs/77"/>
    <updated>2011-04-24T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/77</id>
    <content type="html"><![CDATA[<p>从用户角度看，<a href="http://wiki.apache.org/solr/SolrFacetingOverview">faceted search</a>把搜索结果分入多个类别(一般还会显示各个类别下有多少结果)，并允许用户分类别查看。在电子商务类网站经常可以看到，如</p>

<ul>
<li><a href="http://s.taobao.com/search?q=%C9%CF%CD%F8%B1%BE">淘宝</a> 显示全部分类</li>
<li><a href="http://www.amazon.cn/s/ref=nb_ss?url=search-alias%3Daps&amp;amp;keywords=%E4%B8%8A%E7%BD%91%E6%9C%AC&amp;amp;x=0&amp;amp;y=0">卓越</a> 左侧</li>
<li><a href="http://search.360buy.com/Search?keyword=%C9%CF%CD%F8%B1%BE">京东商城</a> 顶部</li>
</ul>


<p>FacetFields有两种，枚举型和分词型。枚举型适合类别比较少的场景，如卓越。分词型适合于类别很多，但每个document所属的类别较少的情况。Facet field不需要定义成stored,但需要是indexed. facet主要是用在drill-down到搜索结果的一个子集，实际查询是会生成一个对应类别的filter query.</p>

<p>实现原理，枚举型与分词型有些区别</p>

<ul>
<li>枚举型，遍历field的所有terms, 得到各个term对应的document BitSet, 这个结果与query result作与</li>
<li>分词型，遍历搜索结果中的每个document, 从field cache里得到它对应的terms, 累加terms出现次数</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[solr]]></title>
    <link href="http://blog.zzzhc.com/blogs/69"/>
    <updated>2011-04-11T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/69</id>
    <content type="html"><![CDATA[<p><a href="http://lucene.apache.org/solr/">solr</a>是一个基于<a href="http://lucene.apache.org/">lucene</a>，高度可配置的企业级搜索平台。它自己的介绍:</p>

<blockquote><p> Solr is the popular, blazing fast open source enterprise search platform from the Apache Lucene project. Its major features include powerful full-text search, hit highlighting, faceted search, dynamic clustering, database integration, rich document (e.g., Word, PDF) handling, and geospatial search. Solr is highly scalable, providing distributed search and index replication, and it powers the search and navigation features of many of the world&#8217;s largest internet sites.</p></blockquote>

<p><a href="http://lucene.apache.org/solr/features.html">Features</a>有一堆,觉得比较实用的几点有</p>

<ul>
<li>高度可配置，index和query的各部分都能通过配置定制</li>
<li>与数据库表结构类似的索引定义，支持主键，支持基本数据类型(如int), 很容易与表结构关联起来，更新方便</li>
<li>支持<a href="http://wiki.apache.org/solr/MultipleIndexes">multiple indexes</a>, 方便对多个表分别建索引</li>
<li>简单的HTTP接口，开发改进client都很方便</li>
<li>支持replication, 对HA和search scalability提供了一些安慰</li>
<li>简单的后台管理界面，支持查看索引(<a href="http://wiki.apache.org/solr/LukeRequestHandler">LukeRequestHandler</a>),执行查询，有助于debug</li>
<li>丰富的文档，主要是<a href="http://wiki.apache.org/solr/FrontPage">wiki</a></li>
</ul>


<p>几个不足的地方：</p>

<ul>
<li>配置太繁琐，需要反复查文档</li>
<li>管理界面太简陋</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[wiki markup]]></title>
    <link href="http://blog.zzzhc.com/blogs/42"/>
    <updated>2011-04-09T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/42</id>
    <content type="html"><![CDATA[<p>wordpress的编辑器实在不怎么样，想念<a href="http://confluence.atlassian.com/">conflucene</a>的<a href="http://confluence.atlassian.com/renderer/notationhelp.action?section=all">wiki markup</a>.</p>

<p>confluence的wiki markup是从<a href="http://textile.thresholdstate.com/">textile</a>改进过来的，在plugins里找了会，没有好用的textile plugin，像textile 2会把原来的内容变成乱七八遭的，没法忍。</p>

<p>接着试了下markdown, 因为在github的项目上经常看到README.md, 知道是用markdown语法写的。<a href="http://wordpress.org/extend/plugins/markdown-on-save/">markdown on save</a>看起来是没有侵入性的, markdown version放post_content_formatted字段里，对于wordpress 3.1来说放在meta里更好. 参考<a href="http://daringfireball.net/projects/markdown/syntax">markdown syntax</a>练习了一下，基本还好，有两个地方不太满意：</p>

<ul>
<li>ordered list要自己用数字开头,像1.这样来写，同时又忽略这些值的内容，相当反直觉，还是textile里的#爽快</li>
<li>不直接支持table, 虽然可以自己直接写
   &lt;table&gt;&#8230;&lt;/table&gt;
confluence里的||column||column||很简单快捷。</li>
</ul>


<p>先用它了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[nodejs]]></title>
    <link href="http://blog.zzzhc.com/blogs/31"/>
    <updated>2011-04-09T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/31</id>
    <content type="html"><![CDATA[<h2><a href="http://nodejs.org/">nodejs</a> Evented I/O for <a href="http://code.google.com/p/v8/">V8 JavaScript</a>.</h2>

<p>node的目标是提供一种简单的方式来构建可伸缩的网络程序。在node里几乎没有函数会直接执行IO操作，进程从不会阻塞在某个IO等待上。event, callback是node中两个主要的概念，因为IO操作不阻塞，通过event, callback来实现是很自然的。</p>

<p>这一两年node发展很快，有了包管理器(<a href="http://github.com/isaacs/npm">npm</a>)，也出现了各种各样的module, 如</p>

<ul>
<li>Web Framework: <a href="http://github.com/visionmedia/express">Express</a>, node的<a href="http://www.sinatrarb.com/">sinatra</a></li>
<li>template engine: <a href="https://github.com/visionmedia/haml.js">hamljs</a></li>
<li>mysql driver: <a href="http://github.com/felixge/node-mysql">node-mysql</a></li>
<li>mongodb client: <a href="https://github.com/christkv/node-mongodb-native">node-mongodb-native</a></li>
<li>redis client: <a href="https://github.com/mranney/node_redis">node_redis</a></li>
</ul>


<p>有了这些之后要用javascript开发一个web app相对容易多了。</p>

<p>这两天简单试了下，用express, hamljs, node-mongodb-native写了一个最简单的blog app.</p>

<p>安装环境
* install node</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#download source code from http://nodejs.org/dist/</span>
</span><span class='line'><span class="nv">$ </span>wget http://nodejs.org/dist/node-v0.4.5.tar.gz
</span><span class='line'><span class="nv">$ </span>tar -xf node-v0.4.5.tar.gz
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>node-v0.4.5
</span><span class='line'><span class="nv">$ </span>./configure &amp;amp;&amp;amp; make &amp;amp;&amp;amp; sudo make install
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>install mongodb</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#http://www.mongodb.org/downloads</span>
</span><span class='line'><span class="nv">$ </span>wget http://fastdl.mongodb.org/linux/mongodb-linux-i686-1.8.1.tgz
</span><span class='line'><span class="nv">$ </span>tar -xf mongodb-linux-i686-1.8.1.tgz
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>mongodb-linux-i686-1.8.1
</span><span class='line'><span class="nv">$ </span>sudo mkdir -p /data/db
</span><span class='line'><span class="nv">$ </span>sudo chown <span class="sb">`</span>id -u<span class="sb">`</span> -R /data
</span><span class='line'><span class="nv">$ </span>bin/mongod <span class="c"># start mongodb server</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>install npm</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git clone http://github.com/isaacs/npm.git
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>npm
</span><span class='line'><span class="nv">$ </span>sudo make install
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>install modules</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo npm install express
</span><span class='line'><span class="nv">$ </span>sudo npm install hamljs
</span><span class='line'><span class="nv">$ </span>sudo npm install mongodb
</span></code></pre></td></tr></table></div></figure>


<p>express指南见<a href="http://expressjs.com/guide.html">http://expressjs.com/guide.html</a>，它的route方式跟rails比算很弱的，没有对restful的直接支持，但在加上methodOverride后都可以自己定义出来。
模板引擎用hamljs, 通过app.register(&#8216;.haml&#8217;, require(&#8216;hamljs&#8217;))指定。在hamljs layout里要嵌入其它模板内容时可以用!= body。partial可以用!= partial(&#8220;post.haml&#8221;, posts)。!=的意思是对后面的内容不作escape, 细节可以看hamljs代码，很短，不到700行。
mongodb client用起来比较费劲，一层一层的callback, 适当封装下应该会好使点。
最终的代码放在<a href="https://github.com/nodepress/draft">https://github.com/nodepress/draft</a>
性能看起来还是很好的，production模式下(NODE_ENV=production node blog.js) 并发５个连接(ab -c 5 -n 1000 http://localhost:3000/posts/)的结果
Time per request:       1.145 [ms] (mean, across all concurrent requests)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ab -c 5 -n 1000 http://localhost:3000/posts/
</span><span class='line'>....
</span><span class='line'>Server Software:
</span><span class='line'>Server Hostname:        localhost
</span><span class='line'>Server Port:            3000
</span><span class='line'>
</span><span class='line'>Document Path:          /posts/
</span><span class='line'>Document Length:        2950 bytes
</span><span class='line'>
</span><span class='line'>Concurrency Level:      5
</span><span class='line'>Time taken <span class="k">for </span>tests:   1.145 seconds
</span><span class='line'>Complete requests:      1000
</span><span class='line'>Failed requests:        0
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      3073000 bytes
</span><span class='line'>HTML transferred:       2950000 bytes
</span><span class='line'>Requests per second:    873.02 <span class="o">[</span><span class="c">#/sec] (mean)</span>
</span><span class='line'>Time per request:       5.727 <span class="o">[</span>ms<span class="o">]</span> <span class="o">(</span>mean<span class="o">)</span>
</span><span class='line'>Time per request:       1.145 <span class="o">[</span>ms<span class="o">]</span> <span class="o">(</span>mean, across all concurrent requests<span class="o">)</span>
</span><span class='line'>Transfer rate:          2619.90 <span class="o">[</span>Kbytes/sec<span class="o">]</span> received
</span><span class='line'>
</span><span class='line'>Connection Times <span class="o">(</span>ms<span class="o">)</span>
</span><span class='line'>              min  mean<span class="o">[</span>+/-sd<span class="o">]</span> median   max
</span><span class='line'>Connect:        0    0   0.0      0       0
</span><span class='line'>Processing:     3    6   1.8      5      22
</span><span class='line'>Waiting:        3    6   1.8      5      22
</span><span class='line'>Total:          3    6   1.8      5      22
</span><span class='line'>
</span><span class='line'>Percentage of the requests served within a certain <span class="nb">time</span> <span class="o">(</span>ms<span class="o">)</span>
</span><span class='line'>  50%      5
</span><span class='line'>  66%      5
</span><span class='line'>  75%      6
</span><span class='line'>  80%      6
</span><span class='line'>  90%      7
</span><span class='line'>  95%      8
</span><span class='line'>  98%     14
</span><span class='line'>  99%     16
</span><span class='line'>  100%     22 <span class="o">(</span>longest request<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby eventmachine]]></title>
    <link href="http://blog.zzzhc.com/blogs/25"/>
    <updated>2011-04-02T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/25</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/eventmachine/eventmachine">eventmachine</a> 是一个快速轻量的网络协议框架，有不少ruby应用基于它实现，如thin, ruby-amqp. eventmachine在不同os上自动选择最佳的底层网络通知机制，在linux上用epoll，freebsd上用kqueue.</p>

<p>eventmachine对网络事件进行封装，有事件发生时回调预设的handler module。</p>

<p>事件处理都需要放在EventMachine::run里，可以分server, client两种模式</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#server</span>
</span><span class='line'><span class="no">EventMachine</span><span class="o">::</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">EventMachine</span><span class="o">::</span><span class="n">start_server</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="no">ServerHandler</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">#client</span>
</span><span class='line'><span class="no">EventMachine</span><span class="o">::</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">EventMachine</span><span class="o">::</span><span class="n">connect</span> <span class="n">remote_server</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="no">ClientHandler</span> <span class="c1">#client</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在一个网络连接的生存周期中，可能发生的回调事件有：</p>

<ol>
<li>post_init　handler对象创建后，注意client模式时，即使连接还未建立也会被调用</li></li>
<li>connection_completed　主动连接远端服务器，连接建立时</li></li>
<li>receive_data　有数据可读时, 在这里需要处理协议细节</li></li>
<li>unbind　连接关闭，主动关闭，对方关闭或网络错误</li></li>
</ol>


<p>在handler上可以使用send_data发送数据.</p>

<p>最简单的echo server</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">EchoServer</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;-- someone connected to the echo server!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>    <span class="n">send_data</span> <span class="s2">&quot;&gt;&gt;&gt;you sent: </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">close_connection</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/quit/i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">unbind</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;-- someone disconnected from the echo server!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EventMachine</span><span class="o">::</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">EventMachine</span><span class="o">::</span><span class="n">start_server</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">8081</span><span class="p">,</span> <span class="no">EchoServer</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>一个简单的http client</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">HttpClient</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;sending request to server&quot;</span>
</span><span class='line'>    <span class="n">send_data</span> <span class="s2">&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s2">Host: www.baidu.com</span><span class="se">\r\n</span><span class="s2">Connection: close</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;recv: </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">unbind</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;connection closed&quot;</span>
</span><span class='line'>    <span class="no">EventMachine</span><span class="o">::</span><span class="n">stop</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EventMachine</span><span class="o">::</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">EventMachine</span><span class="o">::</span><span class="n">connect</span> <span class="s2">&quot;www.baidu.com&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="no">HttpClient</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>连接失败的例子:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Client</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">connection_completed</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;connected&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;handler inited&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;recv: </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">unbind</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;connection closed&quot;</span>
</span><span class='line'>    <span class="no">EventMachine</span><span class="o">::</span><span class="n">stop</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EventMachine</span><span class="o">::</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">EventMachine</span><span class="o">::</span><span class="n">connect</span> <span class="s2">&quot;api.jquery.com&quot;</span><span class="p">,</span> <span class="mi">8088</span><span class="p">,</span> <span class="no">Client</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Qpid ruby client]]></title>
    <link href="http://blog.zzzhc.com/blogs/17"/>
    <updated>2011-03-31T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/17</id>
    <content type="html"><![CDATA[<p>Qpid对ruby的官方支持：<a href="https://svn.apache.org/repos/asf/qpid/trunk/qpid/ruby/" target="_blank">https://svn.apache.org/repos/asf/qpid/trunk/qpid/ruby/</a></p>

<p>感觉是对python client的port, 代码风格看起来很不ruby, 用了挺多锁，信号，线程，想要停止一个connection都比较困难。对AMQP协议的实现细节被序列化到一个spec_cache下，不可读。基本没有文档，总体来说不像是一个可以正式用的东西。</p>

<p>大概的用法，用rake gem生成gem包，安装gem install pkg/qpid-0.10.2.gem</p>

<p>用qpid java broker的时候要注意下，创建connection的时候要指定用户名密码。
conn = Qpid::Connection.new(TCPSocket.new(&#8220;localhost&#8221;, 5672),
:username => &#8220;guest&#8221;,
:password => &#8220;guest&#8221;)</p>

<p>参考example写了两个简单例子
producer.rb</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;rubygems&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;qpid&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;socket&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">conn</span> <span class="o">=</span> <span class="no">Qpid</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">TCPSocket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">5672</span><span class="p">),</span>
</span><span class='line'>                                         <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="s2">&quot;guest&quot;</span><span class="p">,</span>
</span><span class='line'>                                         <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;guest&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">conn</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ssn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="s2">&quot;test_producer&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create a queue</span>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="s2">&quot;test-queue&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="s2">&quot;test-exchange&quot;</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;direct&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">dp</span> <span class="o">=</span> <span class="n">ssn</span><span class="o">.</span><span class="n">delivery_properties</span><span class="p">(</span><span class="ss">:routing_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;test-queue&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">mp</span> <span class="o">=</span> <span class="n">ssn</span><span class="o">.</span><span class="n">message_properties</span><span class="p">(</span><span class="ss">:content_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">message_transfer</span><span class="p">(</span><span class="ss">:message</span> <span class="o">=&gt;</span> <span class="no">Qpid</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s2">&quot;Hello QPID!&quot;</span><span class="p">))</span>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">message_transfer</span><span class="p">(</span><span class="ss">:message</span> <span class="o">=&gt;</span> <span class="no">Qpid</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s2">&quot;Hello RUBY!&quot;</span><span class="p">))</span>
</span><span class='line'><span class="k">while</span> <span class="n">line</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">strip</span>
</span><span class='line'>  <span class="k">break</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^(exit|done)$/i</span>
</span><span class='line'>  <span class="n">ssn</span><span class="o">.</span><span class="n">message_transfer</span><span class="p">(</span><span class="ss">:message</span> <span class="o">=&gt;</span> <span class="no">Qpid</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">message_transfer</span><span class="p">(</span><span class="ss">:message</span> <span class="o">=&gt;</span> <span class="no">Qpid</span><span class="o">::</span><span class="no">Message</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s2">&quot;done&quot;</span><span class="p">))</span>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">sync</span>
</span><span class='line'>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>consumer.rb</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;rubygems&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;qpid&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;socket&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">conn</span> <span class="o">=</span> <span class="no">Qpid</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">TCPSocket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">5672</span><span class="p">),</span>
</span><span class='line'>                                         <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="s2">&quot;guest&quot;</span><span class="p">,</span>
</span><span class='line'>                                         <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;guest&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">conn</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ssn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="s2">&quot;test_consumer&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">incoming</span> <span class="o">=</span> <span class="n">ssn</span><span class="o">.</span><span class="n">incoming</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">message_subscribe</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:destination</span> <span class="o">=&gt;</span> <span class="s2">&quot;messages&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:queue</span> <span class="o">=&gt;</span> <span class="s2">&quot;test-queue&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:accept_mode</span> <span class="o">=&gt;</span> <span class="n">ssn</span><span class="o">.</span><span class="n">message_accept_mode</span><span class="o">.</span><span class="n">none</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># start incoming message flow</span>
</span><span class='line'><span class="n">incoming</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="kp">true</span>
</span><span class='line'> <span class="n">body</span> <span class="o">=</span> <span class="n">incoming</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">body</span>
</span><span class='line'> <span class="nb">puts</span> <span class="n">body</span>
</span><span class='line'> <span class="k">break</span> <span class="k">if</span> <span class="n">body</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">ssn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>另一个ruby AMQP协议的实现是<a href="https://github.com/ruby-amqp/amqp">ruby-amqp</a> ,基于event-machine, 目前只支持amqp 0-8.</p>

<p>主要是为与rabbitmq通讯打造，简单试了下simple example也可用在qpid上，其它自动的example基本跑不过。现在开发比较活跃，更看好它。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AMQP]]></title>
    <link href="http://blog.zzzhc.com/blogs/4"/>
    <updated>2011-03-30T00:00:00+08:00</updated>
    <id>http://blog.zzzhc.com/blogs/4</id>
    <content type="html"><![CDATA[<p><a href="http://www.amqp.org/">AMQP</a>(Advanced Message Queuing Protocol) 是一个为消息驱动中间件提供的应用层协议，binary protocol. <a href="http://www.amqp.org/confluence/display/AMQP/AMQP+Specification">协议规范</a>有多个版本，0-8版本是支持得最多的。</p>

<p>AMQP的原始用途只是为金融界提供一个可以彼此协作的消息协议，而现在的目标则是为通用消息队列架构提供通用基础架构。因此，面向消息的中间件 （MOM）系统，例如发布/订阅队列，没有作为基本元素实现，而是通过发送简化的AMQ实体来完成。这些实体也是规范的一 部分，形成了在线路层协议顶端的一个层级：AMQP模型。这个模型统一了消息模式，包括发布/订阅，队列，事务以及流数据，路由等。</p>

<h2>几个主要概念:</h2>

<ul>
<li>broker，即AMQP server</li>
<li>message, 内容不可变，没有长度限制</li>
<li>queue, message最终总会进入一个queue</li>
<li>exchange, 为message提供分发服务，按binding规则将message分发到一个或多个queue, 有多种类型，如direct, fanout, topic</li>
<li>binding,　消息路由规则</li>
</ul>


<h2>exchange的类型说明:</h2>

<p><img class="size-full wp-image-5" title="direct exchange" src="http://blog.zzzhc.com/images/posts/direct.jpg" alt="" width="450" height="300" />
<img class="size-full wp-image-7" title="topic exchange" src="http://blog.zzzhc.com/images/posts/topic.jpg" alt="" width="550" height="350" />
<img class="size-full wp-image-6" title="fanout exchange" src="http://blog.zzzhc.com/images/posts/fanout.jpg" alt="" width="450" height="300" /></p>

<p>&nbsp;</p>

<h2>brokers</h2>

<ul>
<li><a href="http://qpid.apache.org/">Apache Qpid</a> 性能很好</li>
<li><a href="http://www.rabbitmq.com/">RabbitMQ</a></li>
<li><a href="http://www.redhat.com/mrg">Red Hat Enterprise MRG</a></li>
<li>&#8230;</li>
</ul>


<h2>Qpid c++ broker性能测试结果</h2>

<p>qpid-perftest &#8211;worker-threads 16 &#8211;default-queue-limit 1024000 &#8211;queue-purge-interval 30 &#8211;tcp-nodelay &#8211;mgmt-enable no</p>

<table>
<tbody>
<tr>
<th><span style="color: #333333;">Message size (bytes)</span></th>
<th><span style="color: #333333;">Total transfers/sec</span></th>
<th> Total Mbytes/sec</th>
</tr>
<tr>
<td>32</td>
<td>708,159</td>
<td>21.6113</td>
</tr>
<tr>
<td>64</td>
<td>627,766</td>
<td>38.3158</td>
</tr>
<tr>
<td>128</td>
<td>537,001</td>
<td>65.5519</td>
</tr>
<tr>
<td>256</td>
<td>487,070</td>
<td>118.914</td>
</tr>
<tr>
<td>512</td>
<td>278,192</td>
<td>135.445</td>
</tr>
<tr>
<td>1024</td>
<td>176,901</td>
<td>172.755</td>
</tr>
</tbody>
</table>


<h2>ruby client</h2>

<ul>
<li><a href="https://svn.apache.org/repos/asf/qpid/trunk/qpid/ruby/">qpid ruby client</a></li>
<li><a href="https://github.com/ruby-amqp/amqp">ruby-amqp</a> 只支持AMQP 0-8</li>
</ul>

]]></content>
  </entry>
  
</feed>
